type strArr = Array<string>;
type coordinate = {x: number, y: number};
// direction specifies the direction of entry into a coordinate, not exit
type direction = 'up'|'right'|'down'|'left'
type locationDirection = {location: coordinate, direction: direction}
const directions: Array<direction> = ['up', 'right', 'down', 'left']

export const testData: strArr = [
    '....#.....',
    '.........#',
    '..........',
    '..#.......',
    '.......#..',
    '..........',
    '.#..^.....',
    '........#.',
    '#.........',
    '......#...',
]

export const fullData: strArr = [
    '..........#...........#...........#.............................#......................#.........#................................',
    '..........................#.........#......#.................................#...........................#........................',
    '..................................#...#................................................................................#..........',
    '.#...............#.....#..........#.........#......#........#................................#......#.............................',
    '...#.......#.............#.............................................#.........##...............#.................#.............',
    '.......................................#.............#..................#........#.......#.........#...............#.........#....',
    '.....#..................#..#..#.........................#...................#....#........#.............................#.........',
    '.......#.............................#..........#......#..........................##......#.......................##..............',
    '.....#.....#........................................................................................#.......#.....................',
    '.................................#............#...#.....................................................#.........#...............',
    '...............#.....#..#....#....#.....................................................#............#........#.#.................',
    '.......#.....#...........................................................#............................#.................#....#....',
    '...........................#.................#....................................#...............#..#........................#...',
    '.....#.........................................#.................#...##....................................#......................',
    '.............#...#..................#......#.................#..........................................#.....#..........#........',
    '.................#...............#............#.......#.#...............................................#..................#......',
    '.....#..#.....................#.......................................................#..............#..............#.......##....',
    '..##........#....................................................#.............#..............#........................#..#.......',
    '..............................#...........#...#........................#............#..........................#........#........#',
    '.....................................##...............................#............#............#....#............................',
    '...##........................#.....#....#.........#.................................................#.............................',
    '...............................#................................#...............#.....#.....................#.....................',
    '................................................#..........#....#............................#.....#.......#..................#...',
    '.............#.....#.........#.#....#................##......#.............#......................................................',
    '..........#..............#..........#......#.........#...#.........................................#.#.....#.........#............',
    '..................#......................#.............................#...................#.....................................#',
    '................#.....#..............................#.............#.............#..#.....#....................................#..',
    '.........#.#................#.........#.................#...................#................................#................#...',
    '.............................................................#..............#.....................................................',
    '......#.........................#...........#.........#..................#....................................#..#...........##...',
    '.............................................................................#.............#........................#...#.........',
    '......#......#..#............#..............................................#....#..#..#................#.........#....#..........',
    '........#........#.........#....................................................^..#...#....................#...............#.....',
    '..#....#...#.......................................................................................................#..............',
    '.....#...........................................#..............#.........#....#........................................#.........',
    '.....................................#..............#............................................................#................',
    '.....#.......................#........................#..........#.............#.................#..................#.............',
    '.......................................#......#.....................................#.........................#...................',
    '...........................................................................................#............................##........',
    '..#............#..........................#...........#...#..................#......#.................#.#.................#......#',
    '.###......#....................#...#...........................................................#.........#.....#..............#.#.',
    '....................................#..........#.....#.......................#...............#.....#......#...................#...',
    '...#......#..................#......#.......#..............#..............#.......................................................',
    '..........#....................................................................#................##.#...#..........................',
    '.........................................................#..................##.....................#..##..........................',
    '..................#......#.................................#.................#.##................................................#',
    '...#..........#...#..#..............................................#...........................##........#.......................',
    '.....#................................................#...........#..................#...#.................................#......',
    '.......#.....#.........................#..........................................................................................',
    '....................................................#........#....#....................................##..............#.....#....',
    '............#........#.........................#.................................#..........................................#...#.',
    '.....................................#........................#...................#......#.#...........#..#..........#...........#',
    '................#...............#.........................#.........................#........#..#.................................',
    '.............#.........#.............#.#.#.........#...................#.......#.......................#..........................',
    '.............#......................................................#................................................#.......#....',
    '....#....................................................................#.#........#.................#..........................#',
    '.................................#......#....................................................................#.....#..............',
    '............##...................#.......................................................................#.........#........#.....',
    '#..................................................#..#...............#............#.............#...............................#',
    '.............................#.................................#.....#..........................#.............#..#...#...#........',
    '...#.....#..............................#.#......................................#................................................',
    '...#............##...............................#............#..............................#................................#...',
    '#.................#......##..............................................................#...........#........#...#...............',
    '....##.....................................................................................................#.#....................',
    '#.................#..................................................#..................................................#.........',
    '.........#.........#...........................#.................#.#.............................#................................',
    '................................#............#................................................................#...................',
    '.....................................#............................................#.##......##........#...........................',
    '....#....................................................#...#.#.#....................................................#...........',
    '.........................#.#...................#...................##...............#........................#....................',
    '..................................#...................................................................#.......#..................#',
    '...................#.............................................#.......................#.#.....................#....#...........',
    '#....................................#.#..#.#..........#.........#.........##.........#......................#............#.......',
    '...............................................................#.............................##....#.......#......................',
    '.............#......#.#.........#............................#............................#.......................................',
    '......................#.........#.........................................................#...#............#......................',
    '...................#.....#.....................................................#.....................................#............',
    '...............................#.....#..................#.......##................................................................',
    '.............................................#.........................#...........#..............................#..#............',
    '#..##..................................................................................................#......#...........#.....#.',
    '.......................................................#.....................#.............................#......................',
    '...........................................................................................................#......................',
    '......................#..............................................................#............................................',
    '...........................#.....#......................................#.........#........#..#.#.................................',
    '.#.......#........................................................................................................................',
    '.#.......#...........................................#................................#...........................................',
    '.........................................................#........................................#......#........................',
    '...............................#...#........#............................................#.................#......................',
    '......#.........................#......................#.....#.#..............#..................#.......#..................#.....',
    '.................#........#...#........................#.............................#............................................',
    '#...........................................................................#............................#................#.......',
    '..........................................................................#................#......................................',
    '.............#.............................................................................#.........................#............',
    '.#...........#.......#.......#.....#....#.......#........#....................#........................#........................#.',
    '...#..............#.............................#.............................................................#...#..#..........#.',
    '......#......#.#...............##................................................................................................#',
    '....#........#.##......#...#......................................................................................................',
    '..#..#.#.#.....................#................................#...................................#.....#...#...................',
    '.....................#.#........#..............##..............#.................#..............................................#.',
    '...................................................................................#........#.......#....#............#...........',
    '.....#....#..................#...............#.............................................#.#....................#...............',
    '.....................#..........#............#..................................#......................#.#.....#................#.',
    '..........#.........................................#...............#.............................................................',
    '.......#......................#.............#.....#..............#........................#.....#.........#.................#...#.',
    '..................................................................#.....#...............................................#........#',
    '.......#..........#.......#....#.......#..........#....#............................................#.#...........................',
    '..#...........#..............................#....................#....................#...#......................................',
    '.......#...............................#............#.....#.....................#.................................................',
    '.........#..................#..................#..................................................................................',
    '..........................................................................................#....#...................#.......##.....',
    '..................#.............................##.......................................................#.......#......#......#..',
    '...#.......#..............................................................................................#.......................',
    '............#..#..............................................................#...........##....#....#.#................#........#',
    '............#.........................#........#....#..#..................................#..................#....................',
    '......##......................#...##..............................#...............................................................',
    '........................#................#..............#...##...............................#..................##....#...........',
    '....#.#...#.....#..................................#..............................#...........#.....................#.............',
    '......................#.........................................................................#..........#.............#........',
    '.#......#............................................................#...............................#...#........................',
    '.......##.....................#.....#...........#......##.......##...................#...............................#............',
    '...#...#........#...............#......#......#.....#...#.................................................................#.......',
    '..................#.......................#...............................................#.................#.............#..#....',
    '.....................#.......#....#...#............................#.....................#............#.....................#.....',
    '................................................................#....#......#............#..................#.........#...........',
    '.......................#...................#..............................................................................###.....',
    '...............................#...........#................................#........#..#....#............................#.......',
    '....#......#...............................#...............#......................................#...............................',
    '...........#...........................##.........................................................................#.#.............',
    '.........................#.........#.........................................#.....#...................#.....#.......#............',
    '.............................#.....#................##..#.....................#...................................................',
]

export class Guard {
    grid: strArr;
    startCoordinate: coordinate | undefined;
    turns: number = 0
    locations: Set<string> = new Set();
    locationsDirections: Set<string> = new Set();
    constructor(input: strArr) {
        this.grid = input
        this.startCoordinate = identifyStart(this.grid)
        if (!this.startCoordinate) { return this }
        this.locations.add(JSON.stringify(this.startCoordinate))
        this.locationsDirections.add(JSON.stringify({location: this.startCoordinate, direction: 'up'}))
        this.#walkRoute(this.startCoordinate, 'up')
    }

    #walkRoute (startingCoordinate: coordinate, direction: direction): undefined {
        let {x, y} = Object.create(startingCoordinate);
        const isOffMap = (x: number, y: number) => {
            return x < 0 || x > this.grid[0].length - 1 || y < 0 || y > this.grid.length - 1;
        }
        while (!isOffMap(x, y)) {
            const nextCoord: coordinate = getNextLocation({x, y}, direction)
            // end if leaves map
            if (isOffMap(nextCoord.x, nextCoord.y)) { break }
            // pivot if encounters obstacle
            if (this.grid[nextCoord.y][nextCoord.x] === '#') {
                direction = pivot(++this.turns);
                // console.log({direction, turns: this.turns})
                continue
            }
            x = nextCoord.x
            y = nextCoord.y
            const nextCoordAndDirection: locationDirection = {location: nextCoord, direction};
            const lDString = JSON.stringify(nextCoordAndDirection)
            // end if repeats a location/direction
            if (this.locationsDirections.has(lDString) || isOffMap(x, y)) {
                break
            } else {
                this.locationsDirections.add(JSON.stringify(nextCoordAndDirection));
                const lString = JSON.stringify(nextCoord)
                this.locations.add(lString);
            }
        }
        return
    }
}

const identifyStart = (grid: strArr) => {
    let x: number|undefined;
    let y: number|undefined;
    for (let i = 0; i < grid.length; i++) {
        const arr = grid[i].match(/\^/);
        if (!arr) {
            continue
        }
        y = i;
        x = arr.index;
        break
    }
    if (x && y) {
        return {x, y}
    } else {
        return undefined
    }
}

export const pivot = (turns: number): direction => {
    return directions[turns % 4]
}

export const getNextLocation = (currentCoordinate: coordinate, direction: direction) => {
    let {x, y} = Object.create(currentCoordinate);
    switch(direction) {
        case "up":
            y --;
            break
        case "right":
            x ++;
            break
        case "down":
            y ++;
            break
        case "left":
            x --;
            break
    }
    return {x, y}
}